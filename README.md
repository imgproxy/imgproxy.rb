# imgproxy.rb

<img align="right" width="200" height="200" title="imgproxy logo"
     src="https://cdn.rawgit.com/DarthSim/imgproxy/master/logo.svg">

[![CircleCI branch](https://img.shields.io/circleci/project/github/imgproxy/imgproxy.rb/master.svg?style=for-the-badge)](https://circleci.com/gh/imgproxy/imgproxy.rb) [![Gem](https://img.shields.io/gem/v/imgproxy.svg?style=for-the-badge)](https://rubygems.org/gems/imgproxy) [![rubydoc.org](https://img.shields.io/badge/rubydoc-reference-blue.svg?style=for-the-badge)](https://www.rubydoc.info/gems/imgproxy)

**[imgproxy](https://github.com/imgproxy/imgproxy)** is a fast and secure standalone server for resizing and converting remote images. The main principles of imgproxy are simplicity, speed, and security. It is a Go application, ready to be installed and used in any Unix environment—also ready to be containerized using Docker.

imgproxy can be used to provide a fast and secure way to replace all the image resizing code of your web application (like calling ImageMagick or GraphicsMagick, or using libraries), while also being able to resize everything on the fly, fast and easy. imgproxy is also indispensable when handling lots of image resizing, especially when images come from a remote source.

**imgproxy.rb** is a Ruby Gem for imgproxy that is framework-agnostic, but includes proper support for Ruby on Rails' most popular image attachment options.

imgproxy.rb provides easy configuration and URL generation as well as plug&play support for [Active Storage](https://edgeguides.rubyonrails.org/active_storage_overview.html) and [Shrine](https://github.com/shrinerb/shrine).

**NOTE:** this readme shows documentation for 2.x version. For version 1.x see the [v1.2.0](https://github.com/imgproxy/imgproxy.rb/tree/v1.2.0) tag. See [2.0-Upgrade.md](2.0-Upgrade.md) for the upgrade guide.

<a href="https://evilmartians.com/?utm_source=imgproxy.rb">
<img src="https://evilmartians.com/badges/sponsored-by-evil-martians.svg" alt="Sponsored by Evil Martians" width="236" height="54">
</a>

## Installation

Add this to your `Gemfile`:

```ruby
gem "imgproxy"
```

or install system-wide:

```
gem install imgproxy
```

## Configuration

Next, some basic configuration. We will use a Ruby on Rails application as an example; place the following code to `config/initializers/imgproxy.rb`:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  # imgproxy endpoint
  #
  # Full URL to where your imgproxy lives.
  config.endpoint = "http://imgproxy.example.com"

  # Next, if you want to sign your URLs,
  # you have to provide your signature key and salt.
  # If unsure, check out https://github.com/imgproxy/imgproxy/blob/master/docs/configuration.md first.

  # Hex-encoded signature key
  config.key = "your_key"
  # Hex-encoded signature salt
  config.salt = "your_salt"
end
```

For more configuration options see [Further configuration](#further-configuration).

**NOTE:** imgproxy gem uses [anyway_config](https://github.com/palkan/anyway_config) for configuration, so you can use [environment variables](https://github.com/palkan/anyway_config#environment-variables) or [YAML files](https://github.com/palkan/anyway_config#using-with-rails) instead of initializer.

## Usage

### Using with Active Storage

imgproxy.rb comes with built-in Active Storage support. It is enabled automagically if you load `imgproxy` gem after `rails` (basically, just put `gem "imgproxy"` after `gem "rails"` in your `Gemfile`). Otherwise, modify your initializer at `config/initializers/imgproxy.rb`:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.extend_active_storage!
```

Now, to add imgproxy processing to your image attachments, just use the `imgproxy_url` method:

```ruby
user.avatar.imgproxy_url(width: 250, height: 250)
```

will give you an URL to your user's avatar, resized to 250x250px on the fly.

If you have configured both your imgproxy server and Active Storage to work with Amazon S3, you may want to use the short `s3://...` source URL scheme instead of the long one generated by Rails:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.use_s3_urls = true
end
```

You can do the same if you are using Google Cloud Storage:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.use_gcs_urls = true
  config.gcs_bucket = "my_bucket"
end
```

**NOTE** that you need to explicitly provide GCS bucket name since Active Storage "hides" the GCS config.

### Using with Shrine

You can also use imgproxy.rb's built-in [Shrine](https://github.com/shrinerb/shrine) support. It is enabled automagically if you load `imgproxy` gem after `shrine` (basically, just put `gem "imgproxy"` after `gem "shrine"` in your `Gemfile`). Otherwise, modify your initializer at `config/initializers/imgproxy.rb`:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.extend_shrine!
```

Now you can use `imgproxy_url` method of `Shrine::UploadedFile`:

```ruby
user.avatar.imgproxy_url(width: 250, height: 250)
```

will give you an URL to your user's avatar, resized to 250x250px on the fly.

**NOTE:** If you use `Shrine::Storage::FileSystem` as storage, uploaded file URLs won't include the hostname, so imgproxy server won't be able to access them. To fix this, use `shrine_host` config:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.shrine_host = "http://your-host.test"
end
```

Alternatively, you can launch your imgproxy server with the `IMGPROXY_BASE_URL` setting:

```
IMGPROXY_BASE_URL="http://your-host.test" imgproxy
```

If you have configured both your imgproxy server and Shrine to work with Amazon S3, you may want to use the short `s3://...` source URL scheme instead of the long one generated by Shrine:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.use_s3_urls = true
end
```

### Usage in a framework-agnostic way

If you use another gem for your attachment operations, you like to keep things minimal or Rails-free, or if you want to generate imgproxy URLs for pictures that did not originate from your application, you can use the `Imgproxy.url_for` method:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)
# => http://imgproxy.example.com/2tjGMpWqjO/rs:fill:500:400/sh:0.5/plain/http://images.example.com/images/image.jpg
```

You can reuse processing options by using `Imgproxy::Builder`:

```ruby
builder = Imgproxy::Builder.new(
  width: 500,
  height: 400,
  resizing_type: :fill,
  sharpen: 0.5
)

builder.url_for("http://images.example.com/images/image1.jpg")
builder.url_for("http://images.example.com/images/image2.jpg")
```

### Supported imgproxy processing options

* [resize](https://docs.imgproxy.net/#/generating_the_url_advanced?id=resize)
* [size](https://docs.imgproxy.net/#/generating_the_url_advanced?id=size)
* [resizing_type](https://docs.imgproxy.net/#/generating_the_url_advanced?id=resizing-type)
* [width](https://docs.imgproxy.net/#/generating_the_url_advanced?id=width)
* [height](https://docs.imgproxy.net/#/generating_the_url_advanced?id=height)
* [dpr](https://docs.imgproxy.net/#/generating_the_url_advanced?id=dpr)
* [enlarge](https://docs.imgproxy.net/#/generating_the_url_advanced?id=enlarge)
* [extend](https://docs.imgproxy.net/#/generating_the_url_advanced?id=extend)
* [gravity](https://docs.imgproxy.net/#/generating_the_url_advanced?id=gravity)
* [crop](https://docs.imgproxy.net/#/generating_the_url_advanced?id=crop)
* [trim](https://docs.imgproxy.net/#/generating_the_url_advanced?id=trim)
* [padding](https://docs.imgproxy.net/#/generating_the_url_advanced?id=padding)
* [quality](https://docs.imgproxy.net/#/generating_the_url_advanced?id=quality)
* [max_bytes](https://docs.imgproxy.net/#/generating_the_url_advanced?id=max-bytes)
* [background](https://docs.imgproxy.net/#/generating_the_url_advanced?id=background)
* [adjust](https://docs.imgproxy.net/#/generating_the_url_advanced?id=adjust) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [brightness](https://docs.imgproxy.net/#/generating_the_url_advanced?id=brightness) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [contrast](https://docs.imgproxy.net/#/generating_the_url_advanced?id=contrast) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [saturation](https://docs.imgproxy.net/#/generating_the_url_advanced?id=saturation) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [blur](https://docs.imgproxy.net/#/generating_the_url_advanced?id=blur)
* [sharpen](https://docs.imgproxy.net/#/generating_the_url_advanced?id=sharpen)
* [pixelate](https://docs.imgproxy.net/#/generating_the_url_advanced?id=pixelate) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [watermark](https://docs.imgproxy.net/#/generating_the_url_advanced?id=watermark)
* [watermark_url](https://docs.imgproxy.net/#/generating_the_url_advanced?id=watermark-url) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [style](https://docs.imgproxy.net/#/generating_the_url_advanced?id=style) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [video_thumbnail_second](https://docs.imgproxy.net/#/generating_the_url_advanced?id=video-thumbnail-second) <img class='pro-badge' src='https://docs.imgproxy.net/assets/pro.svg' alt='pro' style='height: 1em;vertical-align: text-bottom' />
* [preset](https://docs.imgproxy.net/#/generating_the_url_advanced?id=preset)
* [cachebuster](https://docs.imgproxy.net/#/generating_the_url_advanced?id=cachebuster)
* [filename](https://docs.imgproxy.net/#/generating_the_url_advanced?id=filename)
* [format](https://docs.imgproxy.net/#/generating_the_url_advanced?id=format)

_See [imgproxy URL format guide](https://docs.imgproxy.net/#/generating_the_url_advanced?id=processing-options) for more info._

### Complex processing options

Some of the processing options like `crop` or `gravity` may have multiple arguments, and you can define these arguments multiple ways:

#### Named arguments

First and the most readable way is to use a `Hash` with named arguments:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  crop: {
    width: 500,
    height: 600,
    gravity: {
      type: :nowe,
      x_offset: 10,
      y_offset: 5
    }
  }
)
# => .../c:500:600:nowe:10:5/...
```

All the argguments have the same names as in [imgproxy documentation](https://docs.imgproxy.net/#/generating_the_url_advanced?id=processing-options).

You can use named arguments even if the processing option is not supported by the gem. In this case the arguments won't be reordered nor formatted, so you should provide them in the same order and right the same way they should appear in the URL:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  unsupported: {
    arg1: 1,
    nested1: {
      arg2: 2,
      nested2: {
        arg3: 3
      }
    }
  }
)
# => .../unsupported:1:2:3/...
```

#### Unnamed arguments

The arguments of the complex options can be provided as an array of formatted values or even as a formatted string:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  crop: [500, 600, :nowe, 10, 5],
  trim: "10:aabbcc:1:1"
)
# => .../c:500:600:nowe:10:5/t:10:aabbcc:1:1/...
```

#### Single required argument

If a complex option has a single required argument, and you don't want to use the optional ones, you can just use its value:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  gravity: :nowe,
  trim: 10
)
# => .../g:nowe/t:10/...
```

### Base64 processing options arguments

Some of the processing options like `watermark_url` or `style` require their arguments to be base64-encoded. Good news is that imgproxy gem will encode them for you:

```ruby
Imgproxy.url_for(
  "http://images.example.com/images/image.jpg",
  watermark_url: "http://example.com/watermark.jpg",
  style: "color: rgba(255, 255, 255, .5)"
)
# => .../wmu:aHR0cDovL2V4YW1wbGUuY29tL3dhdGVybWFyay5qcGc/st:Y29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgLjUp/...
```

### Special options:

* `base64_encode_url` — per-call redefinition of `base64_encode_urls` config.
* `escape_plain_url` — per-call redefinition of `always_escape_plain_urls` config.
* `use_short_options` — per-call redefinition of `use_short_options` config.

## Further configuration

### Using truncated signature

By default, the imgproxy server uses a full-length signature (32 bytes), but you can set signature length with `IMGPROXY_SIGNATURE_SIZE` environment variable. If you have configured your imgproxy server to use truncated signatures, you need to configure the gem too:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.signature_size = 5
end
```

### Using full processing options names

By default, imgproxy gem uses short processing options names (`rs` for `resize`, `g` for `gravity`, etc), but it can be configured to use full names:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.use_short_options = false
end
```

### Using base64-encoded source URLs

By default, imgproxy gem uses plain source URLs, but you can configure it to encode them to base64:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.base64_encode_urls = true
end
```

### Always escape plain URLs

By default, imgproxy gem escapes your source URLs only when they need to be escaped. But if you want them to always be escaped, you can configure this:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.always_escape_plain_urls = true
end
```

### Using raw key & salt

If you have raw (not hex-encoded) key and salt, you can use them with `raw_key` and `raw_salt` config options:

```ruby
# config/initializers/imgproxy.rb

Imgproxy.configure do |config|
  config.raw_key = "your_raw_key"
  config.raw_salt = "your_raw_salt"
end
```

## URL adapters

By default, `Imgproxy.url_for` accepts only `String` and `URI` as the source URL, but you can extend that behavior by using URL adapters.

URL adapter is a simple class that implements `applicable?` and `url` methods. See the example below:

```ruby
class MyItemAdapter
  # `applicable?` checks if the adapter can extract
  # source URL from the provided object
  def applicable?(item)
    item.is_a? MyItem
  end

  # `url` extracts source URL from the provided object
  def url(item)
    item.image_url
  end
end

# ...

Imgproxy.configure do |config|
  config.url_adapters.add MyItemAdapter.new
end
```

**NOTE:** `Imgproxy` will use the first applicable URL adapter. If you need to add your adapter to the beginning of the list, use the `prepend` method instead of `add`.

**NOTE:** imgproxy.rb provides built-in adapters for Active Storage and Shrine that are automatically added when Active Storage or Shrine support is enabled.

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/imgproxy/imgproxy.rb.

If you are having any problems with image processing of imgproxy itself, be sure to visit https://github.com/imgproxy/imgproxy first and check out the docs at https://github.com/imgproxy/imgproxy/blob/master/docs/.

## License

The gem is available as open source under the terms of the [MIT License](http://opensource.org/licenses/MIT).

## Security Contact

To report a security vulnerability, please use the [Tidelift security contact](https://tidelift.com/security). Tidelift will coordinate the fix and disclosure.
